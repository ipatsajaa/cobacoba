<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMELESS â€” PRO SESSION</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- STYLES TETEP BRUTAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0e0e0e; color: #fff; font-family: 'Space Grotesk', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; min-height: 100vh; overflow-x: hidden; }

        /* Status Bar */
        .status-bar { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; max-width: 450px; justify-content: space-between; }
        .mode-tag { background: #ff4d00; color: #000; padding: 5px 15px; font-family: 'Archivo Black'; font-size: 12px; text-transform: uppercase; box-shadow: 4px 4px 0 #fff; }
        .pose-counter { background: #fff; color: #000; padding: 5px 15px; font-family: 'Archivo Black'; font-size: 12px; }

        /* Cam Box */
        .cam-box { width: 100%; max-width: 450px; aspect-ratio: 4/3; background: #000; position: relative; overflow: hidden; border: 5px solid #fff; box-shadow: 10px 10px 0 #ff4d00; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: none; z-index: 20; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Archivo Black'; font-size: 100px; color: #ff4d00; text-shadow: 4px 4px 0 #fff; z-index: 10; display: none; }

        /* Inventory / Gallery Preview */
        .inventory-section { width: 100%; max-width: 450px; margin-top: 15px; }
        .inventory-label { font-family: 'Archivo Black'; font-size: 10px; margin-bottom: 5px; color: #ff4d00; text-transform: uppercase; }
        .inventory-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .inv-item { position: relative; width: 80px; height: 60px; border: 2px solid #fff; flex-shrink: 0; background: #222; }
        .inv-item img { width: 100%; height: 100%; object-fit: cover; }
        .inv-item .retake-btn { position: absolute; top: -5px; right: -5px; background: #ff4d00; color: #fff; border: none; font-size: 10px; width: 18px; height: 18px; cursor: pointer; font-weight: bold; border-radius: 50%; }

        /* Controls */
        .main-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 450px; margin-top: 15px; }
        .btn { padding: 15px; font-family: 'Archivo Black'; border: none; cursor: pointer; text-transform: uppercase; font-size: 14px; transition: 0.1s; }
        .btn-live { background: #00ff00; color: #000; box-shadow: 4px 4px 0 #fff; }
        .btn-capture { background: #fff; color: #000; box-shadow: 4px 4px 0 #ff4d00; }
        .btn-finish { grid-column: span 2; background: #ff4d00; color: #fff; margin-top: 5px; display: none; box-shadow: 4px 4px 0 #fff; }
        .btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0; }
        .recording { animation: pulse 1s infinite; background: #ff0000 !important; color: #fff; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #resultCanvas { display: none; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div class="mode-tag" id="modeTag">PHOTO MODE</div>
        <div class="pose-counter" id="poseDisplay">0/0</div>
    </div>

    <div class="cam-box">
        <div id="flash"></div>
        <div id="countdown">3</div>
        <video id="videoFeed" autoplay playsinline></video>
    </div>

    <div class="inventory-section">
        <div class="inventory-label">Inventory / Last Shots (Click X to Retake)</div>
        <div class="inventory-grid" id="inventoryGrid">
            </div>
    </div>

    <div class="main-controls">
        <button class="btn btn-live" id="liveBtn" onclick="toggleLive()">LIVE (GIF)</button>
        <button class="btn btn-capture" id="capBtn" onclick="startSingleCapture()">CAPTURE</button>
        <button class="btn btn-finish" id="finishBtn" onclick="processFinalFrame()">GENERATE FRAME</button>
    </div>

    <canvas id="resultCanvas"></canvas>

    <script>
        const video = document.getElementById('videoFeed');
        const invGrid = document.getElementById('inventoryGrid');
        const modeTag = document.getElementById('modeTag');
        const finishBtn = document.getElementById('finishBtn');
        const countdownEl = document.getElementById('countdown');
        
        let photos = []; // Simpan data URL foto
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];

        // Konfigurasi Layout dari Halaman Sebelumnya
        const selectedLayout = localStorage.getItem('selectedLayout') || 'layoutA';
        let maxPoses = (selectedLayout === 'layoutB') ? 4 : (selectedLayout === 'layoutF' ? 2 : (selectedLayout === 'layoutG' ? 1 : 3));
        
        document.getElementById('poseDisplay').innerText = `SHOTS: 0/${maxPoses}`;

        // Init Kamera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 960 } });
                video.srcObject = stream;
            } catch (err) { alert("Camera Error!"); }
        }

        // --- FITUR CAPTURE + INVENTORY ---
        async function startSingleCapture() {
            if (photos.length >= maxPoses) return alert("Inventory Full! Remove or Finish.");
            
            await runCountdown(3);
            
            // Flash Effect
            const flash = document.getElementById('flash');
            flash.style.display = 'block';
            setTimeout(() => flash.style.display = 'none', 100);

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            photos.push(dataUrl);
            updateInventory();
        }

        function updateInventory() {
            invGrid.innerHTML = '';
            photos.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.innerHTML = `<img src="${src}"><button class="retake-btn" onclick="removePhoto(${index})">X</button>`;
                invGrid.appendChild(div);
            });
            
            document.getElementById('poseDisplay').innerText = `SHOTS: ${photos.length}/${maxPoses}`;
            finishBtn.style.display = (photos.length === maxPoses) ? 'block' : 'none';
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updateInventory();
        }

        // --- FITUR LIVE (GIF/VIDEO RECORDER) ---
        function toggleLive() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            const stream = video.srcObject;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `live_moment_${Date.now()}.webm`;
                a.click();
            };

            mediaRecorder.start();
            isRecording = true;
            modeTag.innerText = "REC LIVE";
            document.getElementById('liveBtn').classList.add('recording');
            document.getElementById('liveBtn').innerText = "STOP LIVE";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            modeTag.innerText = "PHOTO MODE";
            document.getElementById('liveBtn').classList.remove('recording');
            document.getElementById('liveBtn').innerText = "LIVE (GIF)";
        }

        // --- UTILS ---
        function runCountdown(sec) {
            return new Promise(resolve => {
                let count = sec;
                countdownEl.style.display = 'block';
                countdownEl.innerText = count;
                const timer = setInterval(() => {
                    count--;
                    if(count <= 0) { clearInterval(timer); countdownEl.style.display = 'none'; resolve(); }
                    else { countdownEl.innerText = count; }
                }, 1000);
            });
        }

        function processFinalFrame() {
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
            window.location.href = 'result.html'; // Pindah ke halaman hasil final
        }

        window.onload = initCamera;
    </script>
</body>
</html>
