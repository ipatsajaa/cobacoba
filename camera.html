<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMELESS â€” PRO SESSION</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0e0e0e; color: #fff; font-family: 'Space Grotesk', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; min-height: 100vh; overflow-x: hidden; }

        /* Header UI */
        .header-ui { display: flex; justify-content: space-between; width: 100%; max-width: 450px; margin-bottom: 15px; }
        .badge { background: #ff4d00; color: #000; padding: 5px 15px; font-family: 'Archivo Black'; font-size: 12px; box-shadow: 4px 4px 0 #fff; text-transform: uppercase; }

        /* Cam Box */
        .cam-box { width: 100%; max-width: 450px; aspect-ratio: 4/3; background: #000; border: 4px solid #fff; position: relative; overflow: hidden; box-shadow: 10px 10px 0 #ff4d00; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .live-indicator { position: absolute; top: 15px; left: 15px; display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px; z-index: 5; }
        .dot { width: 8px; height: 8px; background: red; border-radius: 50%; animation: blink 0.8s infinite; }
        
        /* INVENTORY PREVIEW */
        .inventory-container { width: 100%; max-width: 450px; margin-top: 20px; }
        .inventory-title { font-family: 'Archivo Black'; font-size: 14px; margin-bottom: 10px; color: #ff4d00; text-transform: uppercase; }
        .inventory-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; min-height: 120px; }
        .inv-card { width: 100px; flex-shrink: 0; position: relative; border: 2px solid #fff; background: #222; }
        .inv-card img { width: 100%; height: 100%; object-fit: cover; }
        .btn-remove { position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; width: 20px; height: 20px; font-size: 12px; cursor: pointer; border-radius: 50%; font-weight: bold; }

        /* Controls */
        .controls { width: 100%; max-width: 450px; display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; font-family: 'Archivo Black'; border: none; cursor: pointer; text-transform: uppercase; transition: 0.1s; }
        .btn-main { background: #fff; color: #000; box-shadow: 6px 6px 0 #ff4d00; }
        .btn-main:active { transform: translate(3px, 3px); box-shadow: 0 0 0; }
        .btn-done { background: #ff4d00; color: #fff; box-shadow: 6px 6px 0 #fff; display: none; }

        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Archivo Black'; font-size: 80px; color: #ff4d00; z-index: 10; text-shadow: 4px 4px 0 #fff; display: none; }
        #flash { position: absolute; inset: 0; background: #fff; z-index: 20; display: none; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.2; } }
    </style>
</head>
<body>

    <div class="header-ui">
        <div class="badge">POSE: <span id="countDisplay">0</span>/<span id="maxDisplay">3</span></div>
        <div class="badge" style="background: #00ff00;">LIVE ACTIVE</div>
    </div>

    <div class="cam-box">
        <div id="flash"></div>
        <div id="countdown">3</div>
        <div class="live-indicator"><div class="dot"></div> LIVE</div>
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="resultCanvas" style="display:none;"></canvas>
    </div>

    <div class="inventory-container">
        <div class="inventory-title">Your Inventory*</div>
        <div class="inventory-grid" id="inventoryGrid">
            </div>
    </div>

    <div class="controls">
        <button class="btn btn-main" id="snapBtn" onclick="takePhoto()">CAPTURE*</button>
        <button class="btn btn-done" id="processBtn" onclick="processFrame()">GENERATE FRAME*</button>
    </div>

    <script>
        const video = document.getElementById('videoFeed');
        const invGrid = document.getElementById('inventoryGrid');
        const countDisplay = document.getElementById('countDisplay');
        const processBtn = document.getElementById('processBtn');
        const snapBtn = document.getElementById('snapBtn');

        let photos = []; // Nyimpen base64 foto
        let gifs = [];   // Nyimpen data GIF kalau mau dikembangkan
        const selectedLayout = localStorage.getItem('selectedLayout') || 'layoutA';
        
        // Atur Max Pose berdasarkan Layout
        let maxPoses = (selectedLayout === 'layoutB') ? 4 : (selectedLayout === 'layoutG') ? 1 : 3;
        document.getElementById('maxDisplay').innerText = maxPoses;

        // Init Kamera
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 960 } });
                video.srcObject = stream;
            } catch (err) { alert("Camera Error! Check Permissions."); }
        }

        async function takePhoto() {
            if (photos.length >= maxPoses) return alert("Inventory Full! Hapus dulu kalau mau ganti.");
            
            snapBtn.disabled = true;
            await runCountdown(3);

            // Efek Flash
            const flash = document.getElementById('flash');
            flash.style.display = 'block';
            setTimeout(() => flash.style.display = 'none', 100);

            // FITUR LIVE: Capture Frame buat GIF (Simple Implementation via Canvas)
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            photos.push(dataUrl);
            updateInventory();

            snapBtn.disabled = false;
        }

        function runCountdown(sec) {
            return new Promise(res => {
                let c = sec;
                const el = document.getElementById('countdown');
                el.style.display = 'block';
                el.innerText = c;
                const t = setInterval(() => {
                    c--;
                    if (c <= 0) { clearInterval(t); el.style.display = 'none'; res(); }
                    else { el.innerText = c; }
                }, 1000);
            });
        }

        function updateInventory() {
            invGrid.innerHTML = '';
            photos.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'inv-card';
                div.innerHTML = `<img src="${src}"><button class="btn-remove" onclick="removePhoto(${idx})">X</button>`;
                invGrid.appendChild(div);
            });
            
            countDisplay.innerText = photos.length;
            processBtn.style.display = (photos.length === maxPoses) ? 'block' : 'none';
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updateInventory();
        }

        function processFrame() {
            // Simpan array foto ke LocalStorage buat dirender di hasil akhir
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
            window.location.href = 'result.html'; // Pindah ke halaman hasil
        }

        window.onload = init;
    </script>
</body>
</html>
