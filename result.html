<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result - Photobooth</title>
    <style>
        /* Tema Coklat Estetik */
        body { 
            background: #F5EBE0; 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            color: #4E342E; 
            min-height: 100vh;
        }
        
        h2 { margin-bottom: 20px; font-weight: 600; }

        .result-container { 
            background: white; 
            padding: 10px; 
            box-shadow: 0 10px 30px rgba(78, 52, 46, 0.15); 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }

        #finalCanvas { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            border-radius: 4px;
        }

        .btn-group { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            width: 100%; 
            max-width: 320px; 
        }

        button { 
            padding: 16px; 
            border-radius: 50px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }

        .btn-download { background: #6D4C41; color: white; box-shadow: 0 4px 10px rgba(109, 76, 65, 0.3); }
        .btn-download:hover { background: #5D4037; transform: translateY(-2px); }

        .btn-gif { background: #D5BDAF; color: #4E342E; }
        .btn-gif:hover { background: #C3A99B; }

        .btn-retake { 
            background: transparent; 
            border: 2px solid #6D4C41; 
            color: #6D4C41; 
        }
        .btn-retake:hover { background: #6D4C41; color: white; }

        #loading { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: white; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
            font-weight: bold; 
        }
        
        /* Animasi sederhana untuk loading */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #F5EBE0;
            border-top: 4px solid #6D4C41;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p>Creating your strip...</p>
    </div>

    <h2>Stunning! âœ¨</h2>
    
    <div class="result-container">
        <canvas id="finalCanvas"></canvas>
    </div>

    <div class="btn-group">
        <button class="btn-download" onclick="downloadImage()">Download Photo</button>
        <button class="btn-gif" onclick="downloadGIF()">Download GIF</button>
        <button class="btn-retake" onclick="window.location.href='index.html'">Take Another One</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>

    <script>
        const canvas = document.getElementById('finalCanvas');
        const ctx = canvas.getContext('2d');
        const capturedPhotos = JSON.parse(localStorage.getItem('capturedPhotos') || '[]');
        const selectedLayout = localStorage.getItem('selectedLayout') || 'layoutA';

        const frameImg = new Image();
        // Path frame disesuaikan dengan pilihan di halaman sebelumnya
        frameImg.src = selectedLayout === 'layoutA' ? 'frames/framea.png' : 'frames/frameb.png';

        function initResult() {
            if (capturedPhotos.length === 0) {
                alert("No photos found!");
                window.location.href = 'index.html';
                return;
            }

            frameImg.onload = () => {
                // Ukuran canvas wajib sama dengan ukuran file PNG dari Canva agar tidak pecah
                canvas.width = frameImg.width;
                canvas.height = frameImg.height;

                let config;

                if (selectedLayout === 'layoutA') {
                    // KONFIGURASI LAYOUT A (3 FOTO) - Berdasarkan Screenshot Canva
                    config = {
                        count: 3,
                        photoW: 700,
                        photoH: 525,
                        startX: 50,
                        startY: 79.8,
                        gap: 219    // Jarak antar lubang
                    };
                } else {
                    // KONFIGURASI LAYOUT B (4 FOTO) - Sesuaikan jika ada perbedaan koordinat
                    config = {
                        count: 4,
                        photoW: 700,
                        photoH: 420,   // Tinggi biasanya lebih pendek untuk 4 foto
                        startX: 50,
                        startY: 60,
                        gap: 89
                    };
                }

                drawStrip(config);
            };
        }

        function drawStrip(cfg) {
            let loadedCount = 0;

            capturedPhotos.forEach((src, index) => {
                // Jangan menggambar jika index melebihi kapasitas layout (misal foto ke-4 di layout 3 foto)
                if (index >= cfg.count) return;

                const img = new Image();
                img.src = src;
                img.onload = () => {
                    const xPos = cfg.startX;
                    const yPos = cfg.startY + (index * (cfg.photoH + cfg.gap));
                    
                    // --- LOGIKA CENTER CROP (MENCEGAH GEPENG) ---
                    const imgRatio = img.width / img.height;
                    const targetRatio = cfg.photoW / cfg.photoH;
                    let sw, sh, sx, sy;

                    if (imgRatio > targetRatio) {
                        // Foto terlalu lebar
                        sh = img.height;
                        sw = img.height * targetRatio;
                        sx = (img.width - sw) / 2;
                        sy = 0;
                    } else {
                        // Foto terlalu tinggi
                        sw = img.width;
                        sh = img.width / targetRatio;
                        sx = 0;
                        sy = (img.height - sh) / 2;
                    }

                    // 1. Gambar foto di layer bawah
                    ctx.drawImage(img, sx, sy, sw, sh, xPos, yPos, cfg.photoW, cfg.photoH);
                    
                    loadedCount++;
                    // 2. Jika semua foto sudah masuk, tumpuk Frame PNG di layer atas
                    if (loadedCount === Math.min(capturedPhotos.length, cfg.count)) {
                        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
                        document.getElementById('loading').style.display = 'none';
                    }
                };
            });
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'photobooth_' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        function downloadGIF() {
            const btn = document.querySelector('.btn-gif');
            const originalText = btn.innerText;
            btn.innerText = "PROCESSING...";
            btn.disabled = true;

            gifshot.createGIF({
                images: capturedPhotos,
                gifWidth: 600, 
                gifHeight: 450,
                interval: 0.5,
                numFrames: capturedPhotos.length,
            }, function (obj) {
                if (!obj.error) {
                    const link = document.createElement('a');
                    link.download = 'moment_animasi.gif';
                    link.href = obj.image;
                    link.click();
                } else {
                    alert("GIF failed to generate.");
                }
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }

        window.onload = initResult;
    </script>
</body>
</html>